(define *tracks* '())

;; 'a = fbmz
;; 'b = fh

(define (add-track name length &!optional (signal 'both))
  (set! *tracks* (cons (cons name
			     (list (cons 'signal signal);; 'a 'b 'both 'none
			           (cons 'length length)
				   (cons 'link-a '())
				   (cons 'link-b '())
			           (cons 'usage  '())))
		       *tracks*)))

(define (link-tracks track-a track-b)
  (let ((a (assq track-a *tracks*))
	(b (assq track-b *tracks*)))
    (if (not (and a b)) (error "track not found"))
    (let ((b-link-of-a (assq 'link-b (cdr a)))
	  (b-link-of-b (assq 'link-a (cdr b))))
      (if (not (and b-link-of-a a-link-of-b)) (error "malformed tracks"))
      (set-cdr! b-link-of-a (cons track-b (cdr b-link-of-a)))
      (set-cdr! a-link-of-b (cons track-a (cdr a-link-of-b))))))

(define (add-link-track track-a track-b length signal)
  (let ((name (symbol-append track-a track-b)))
    (add-track name length signal)
    (link-track track-a name)
    (link-track name track-b)))

(define (add-tracks-tree track bk track-bk-cons-list side-of-single &!optional (signal 'none))
  (for-each (lambda (t)
	      (let ((a (if (eq? side-of-single 'a) track (car t)))
		    (b (if (eq? side-of-single 'a) (car t) track)))
		(add-link-track a b (abs (- bk (cdr t))) signal)))track-bk-cons-list))

(add-track 'fovr-301 433)
(add-track 'fovr-302 421)
(add-track 'fovr-303 422)
(add-track 'fovr-304 422)
(add-track 'fovr-305 423)

(add-track 'fovr-399 320)

(add-track 'fovr-401 285)
(add-track 'fovr-402 271)
(add-track 'fovr-403 290)
(add-track 'fovr-404 280)
(add-track 'fovr-405 240)
(add-track 'fovr-406 290)
(add-track 'fovr-407 270)
(add-track 'fovr-408 270)
(add-track 'fovr-409 255)
(add-track 'fovr-410 254)
(add-track 'fovr-411 250)
(add-track 'fovr-412 250)
(add-track 'fovr-413 248)
(add-track 'fovr-414 283)
(add-track 'fovr-415 288)
(add-track 'fovr-416 127)	   

(add-track 'fovr-502 304)
(add-track 'fovr-503 255)
(add-track 'fovr-504 255)
(add-track 'fovr-505 255)
(add-track 'fovr-506 300)
(add-track 'fovr-507 260)
(add-track 'fovr-508 290)
(add-track 'fovr-509 252)
(add-track 'fovr-510 289)

(add-track 'fovr-601 258)
(add-track 'fovr-602 259)
(add-track 'fovr-603 260)
(add-track 'fovr-604 261)
(add-track 'fovr-605 255)
(add-track 'fovr-606 253)
(add-track 'fovr-607 255)
(add-track 'fovr-608 240)
(add-track 'fovr-609 199)
(add-track 'fovr-610 73)

(add-track 'fovr-701 104)
(add-track 'fovr-702 200)
(add-track 'fovr-703 155)
(add-track 'fovr-704 200)
(add-track 'fovr-705 331)
(add-track 'fovr-706 287)
(add-track 'fovr-708 299)
(add-track 'fovr-709 302)
(add-track 'fovr-710 451)
(add-track 'fovr-711 409)
(add-track 'fovr-712 434)
(add-track 'fovr-713 588)


(add-track 'fovr-920 420)
(add-track 'fovr-926 405)
(add-track 'fovr-931 (- 2782 2659))
(add-track 'fovr-940 107)
(add-track 'fovr-941  36)
(add-track 'fovr-942  49)
(add-track 'fovr-946 200)
(add-track 'fovr-947  35)
(add-track 'fovr-951 (- 2997 2873))
(add-track 'fovr-952 43) ;mesuré a l'odométrie de la 77
(add-track 'fovr-953 35)
(add-track 'fovr-961 207)
(add-track 'fovr-962  20) ;au pif
(add-track 'fovr-966  67)
(add-track 'fovr-970  46)
(add-track 'fovr-976  77);; odométrie 77
 
;; 976 : 77m
;; 976 - 966 : 211m
;; 966 : 347- 288: 59m
;; 996 - 926 : 95m


(add-track 'fovr-N5K (- 3280 3181) 'a)
(add-track 'fovr-N6K (- 3280 3148) 'a)
(add-track 'fovr-N7K (- 3280 3138) 'a)
(link-tracks 'fovr-N5K 'fovr-966)
(link-tracks 'fovr-N6K 'fovr-966)
(link-tracks 'fovr-N7K 'fovr-966)
(add-track-tree 'fovr-N5K 3181 '((fovr-502 . 3349)
			         (fovr-503 . 3340)
			         (fovr-504 . 3338)
			         (fovr-505 . 3332)
			         (fovr-506 . 3408))
		'b)
(add-track-tree 'fovr-N6K 3148  '((fovr-507 . 3375)
				  (fovr-508 . 3329)
			  	  (fovr-509 . 3329)
				  (fovr-510 . 3364))
		'b)
(add-track-tree 'fovr-N7K 3138 '((fovr-601 . 3467)
				 (fovr-602 . 3472)
				 (fovr-603 . 3475)
				 (fovr-604 . 3472);; maybe
				 (fovr-605 . 3457)
				 (fovr-606 . 3461)
				 (fovr-607 . 3487)
				 (fovr-608 . 3497)
				 (fovr-609 . 3513))
		'b)

(add-track 'fovr-966-976 211 'none)
(link-tracks 'fovr-966-976 'fovr-966)
(link-tracks 'fovr-976 'fovr-966-976)

(add-track-tree 'fovr-966 '((fovr-301 . 3495)
			    (fovr-302 . 3495)
			    (fovr-303 . 3495)
			    (fovr-304 . 3495)
			    (fovr-305 . 3495))
		'b)

(add-track 'fovr-966-399 (- 3385 3280))
(link-tracks 'fovr-966-399 'fovr-966)
(link-tracks 'fovr-399 'fovr-966-399)

(add-track-tree 'fovr-976 '((fovr-702 . 3255)
			    (fovr-703 . 3209)
			    (fovr-704 . 3209)
			    (fovr-705 . 3267)
			    (fovr-706 . 3238)
			    (fovr-707 . 4264)
			    (fovr-708 . 3222)
			    (fovr-709 . 3223)
			    (fovr-710 . 3297)
			    (fovr-711 . 3298)
			    (fovr-712 . 3322)
			    (fovr-713 . 3324))
		'b)
